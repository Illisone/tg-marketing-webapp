<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö–æ–º–ø–∞–Ω–∏–µ–π</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>üëë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–µ–π</h1>
    
    <div id="loading" class="status">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    <div id="main_content" style="display: none;">
        
        <div id="create_form" style="display: none;">
            <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–ø–∞–Ω–∏—é</h2>
            <div class="form-group">
                <label for="company_name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏:</label>
                <input type="text" id="company_name" placeholder="–ú–æ—è –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∞—è –ö–æ–º–∞–Ω–¥–∞">
                
                <label for="company_code">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ (–¥–ª—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è, >3 —Å–∏–º–≤.):</label>
                <input type="text" id="company_code" placeholder="SECRET2024">
                
                <button onclick="createCompany()">–°–æ–∑–¥–∞—Ç—å –∏ —Å—Ç–∞—Ç—å –í–ª–∞–¥–µ–ª—å—Ü–µ–º</button>
            </div>
        </div>

        <div id="management_interface" style="display: none;">
            <div id="current_company_info" class="current-company"></div>
            
            <div id="company_switcher" class="form-group">
                <h3>–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è:</h3>
                <div id="company_list"></div>
            </div>

            <div id="team-management" class="form-group" style="margin-top: 20px;">
                <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π</h3>
                <table id="team-table">
                    <thead>
                        <tr>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–†–æ–ª—å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody id="team-members">
                        </tbody>
                </table>

                <h4 style="margin-top: 20px;">–î–æ–±–∞–≤–∏—Ç—å —á–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥—ã</h4>
                <input type="text" id="new_member_id" placeholder="Telegram ID –∏–ª–∏ @username">
                <button onclick="addMember()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <p id="status-message" class="status" style="margin-top: 15px;"></p>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        const loadingDiv = document.getElementById('loading');
        const mainContent = document.getElementById('main_content');
        const createForm = document.getElementById('create_form');
        const managementInterface = document.getElementById('management_interface');
        const statusMessage = document.getElementById('status-message');
        
        let currentCompanyId = null; 
        let userRole = null; 

        // --- –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ô –õ–ò–°–ï–ù–ï–† –î–õ–Ø –ü–ï–†–ï–•–í–ê–¢–ê –û–¢–í–ï–¢–û–í –ë–û–¢–ê ---
        tg.onEvent('message', (message) => {
            try {
                const payload = JSON.parse(message.text);
                
                if (payload.event === 'onCustomData' && payload.data) {
                    const data = JSON.parse(payload.data);
                    
                    if (data.companies) {
                        renderCompanyData(data.companies);
                        loadingDiv.style.display = 'none';
                        mainContent.style.display = 'block';
                    } else if (data.team) {
                        renderTeamList(data.team);
                    }
                    
                    if (data.success) {
                        tg.showAlert(data.success);
                        statusMessage.className = 'status success';
                        statusMessage.textContent = data.success;
                        
                        if (data.reload) {
                            loadCompanyData();
                        }
                    } else if (data.error) {
                        tg.showAlert(data.error);
                        statusMessage.className = 'status error';
                        statusMessage.textContent = data.error;
                    }
                }
            } catch (e) {
                console.warn('Ignoring non-WebApp JSON message:', e);
            }
        });


        // --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–û–ú–ü–ê–ù–ò–ï–ô ---

        function loadCompanyData() {
            loadingDiv.style.display = 'block';
            mainContent.style.display = 'none';
            statusMessage.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
            tg.sendData(JSON.stringify({ action: 'get_user_companies' }));
        }
        
        function renderCompanyData(companies) {
            const listDiv = document.getElementById('company_list');
            listDiv.innerHTML = '';
            
            if (companies.length === 0) {
                createForm.style.display = 'block';
                managementInterface.style.display = 'none';
                return;
            }

            createForm.style.display = 'none';
            managementInterface.style.display = 'block';
            
            const currentCompany = companies.find(c => c.is_current) || companies[0];
            
            if (currentCompany) {
                currentCompanyId = currentCompany.id;
                userRole = currentCompany.role;
                
                document.getElementById('current_company_info').innerHTML = `
                    <h2>${currentCompany.name}</h2>
                    <p>–ö–æ–¥: <strong>${currentCompany.secret_code}</strong> | –¢–∞—Ä–∏—Ñ: <strong>${currentCompany.tariff.toUpperCase()}</strong></p>
                    <p>–í–∞—à–∞ —Ä–æ–ª—å: <strong>${currentCompany.role.charAt(0).toUpperCase() + currentCompany.role.slice(1)}</strong></p>
                `;
                
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ/—Å–∫—Ä—ã—Ç–∏–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥–æ–π
                if (['–≤–ª–∞–¥–µ–ª–µ—Ü', '–ø–∞—Ä—Ç–Ω–µ—Ä'].includes(currentCompany.role)) {
                    document.getElementById('team-management').style.display = 'block';
                    loadTeamData(currentCompany.id); 
                } else {
                    document.getElementById('team-management').style.display = 'none';
                }
            }

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
            companies.forEach(company => {
                const btn = document.createElement('button');
                btn.textContent = `${company.name} (${company.role}) ${company.is_current ? '‚úÖ' : ''}`;
                btn.style.marginRight = '10px';
                btn.style.opacity = company.is_current ? 1 : 0.7;
                btn.onclick = () => switchCompany(company.id, company.name);
                listDiv.appendChild(btn);
            });
        }
        
        function switchCompany(companyId, companyName) {
            statusMessage.textContent = `–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–º–ø–∞–Ω–∏—é ${companyName}...`;
            tg.sendData(JSON.stringify({ 
                action: 'switch_company', 
                company_id: companyId 
            }));
        }

        // –ù–û–í–ê–Ø/–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
        function createCompany() {
            const name = document.getElementById('company_name').value.trim();
            const code = document.getElementById('company_code').value.trim().toUpperCase();

            if (name.length < 3 || code.length < 3) {
                tg.showAlert('–ù–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–¥ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤.');
                return;
            }

            statusMessage.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏...';
            tg.sendData(JSON.stringify({ 
                action: 'create_company_from_webapp', 
                name: name, 
                code: code,
                tariff: 'standard' // –ò–ª–∏ 'loner', –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ–±–Ω—ã–π –∑–∞–ø—É—Å–∫
            }));
        }

        // --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–û–ú–ê–ù–î–û–ô ---

        function loadTeamData(companyId) {
            tg.sendData(JSON.stringify({ 
                action: 'get_team', 
                company_id: companyId 
            }));
        }

        function renderTeamList(members) {
            const tbody = document.getElementById('team-members');
            tbody.innerHTML = '';
            
            members.forEach(member => {
                const row = tbody.insertRow();
                
                const nameCell = row.insertCell();
                nameCell.textContent = member.full_name + (member.username ? ` (@${member.username})` : '');

                const roleCell = row.insertCell();
                const actionCell = row.insertCell();
                
                if (['–≤–ª–∞–¥–µ–ª–µ—Ü', '–ø–∞—Ä—Ç–Ω–µ—Ä'].includes(userRole) && member.id !== tg.initDataUnsafe.user.id) {
                    const select = document.createElement('select');
                    select.id = `role_${member.id}`;
                    
                    const roles = ['–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥'];
                    if (userRole === '–≤–ª–∞–¥–µ–ª–µ—Ü') {
                        roles.unshift('–ø–∞—Ä—Ç–Ω–µ—Ä', '–≤–ª–∞–¥–µ–ª–µ—Ü'); 
                    }
                    
                    [...new Set(roles)].forEach(role => {
                        const option = document.createElement('option');
                        option.value = role;
                        option.textContent = role.charAt(0).toUpperCase() + role.slice(1);
                        if (role === member.role) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    roleCell.appendChild(select);

                    actionCell.innerHTML = `<button onclick="changeRole(${member.id}, document.getElementById('role_${member.id}').value)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
                } else {
                    roleCell.textContent = member.role.charAt(0).toUpperCase() + member.role.slice(1);
                    actionCell.textContent = member.role === '–≤–ª–∞–¥–µ–ª–µ—Ü' ? '–í–ª–∞–¥–µ–ª–µ—Ü' : '-';
                }
            });
        }

        function changeRole(targetId, newRole) {
            statusMessage.textContent = `–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏...`;
            tg.sendData(JSON.stringify({ 
                action: 'set_role', 
                target_id: targetId, 
                new_role: newRole 
            }));
        }

        function addMember() {
            const identifier = document.getElementById('new_member_id').value.trim();
            if (!identifier) {
                tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º –∏–ª–∏ ID.");
                return;
            }
            
            statusMessage.textContent = `–î–æ–±–∞–≤–ª–µ–Ω–∏–µ ${identifier}...`;
            tg.sendData(JSON.stringify({ 
                action: 'add_member', 
                identifier: identifier
            }));
            document.getElementById('new_member_id').value = '';
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        loadCompanyData();
    </script>
</body>
</html>