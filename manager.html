<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö–æ–º–ø–∞–Ω–∏–µ–π</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>üëë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–µ–π</h1>
    
    <div id="loading" class="status">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    <div id="main_content" style="display: none;">
        
        <div id="create_form" style="display: none;">
            <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–ø–∞–Ω–∏—é</h2>
            <div class="form-group">
                <label for="company_name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏:</label>
                <input type="text" id="company_name" placeholder="–ú–æ—è –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∞—è –ö–æ–º–∞–Ω–¥–∞">
                
                <label for="company_code">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ (–¥–ª—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è, >3 —Å–∏–º–≤.):</label>
                <input type="text" id="company_code" placeholder="SECRET2024">
                
                <button onclick="createCompany()">–°–æ–∑–¥–∞—Ç—å –∏ —Å—Ç–∞—Ç—å –í–ª–∞–¥–µ–ª—å—Ü–µ–º</button>
            </div>
        </div>

        <div id="management_interface" style="display: none;">
            <div id="current_company_info" class="current-company"></div>
            
            <div id="company_selector" class="form-group" style="display: none;">
                <h2>–í—ã–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –∫–æ–º–ø–∞–Ω–∏—é</h2>
                <select id="company_list_select" onchange="switchCompany(this.value)"></select>
            </div>
            
            <div id="team_management" style="display: none;">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
                <div class="form-group">
                    <label for="new_member_id">–Æ–∑–µ—Ä–Ω–µ–π–º (@username) –∏–ª–∏ Telegram ID:</label>
                    <input type="text" id="new_member_id" placeholder="@username –∏–ª–∏ 123456789">
                    <button onclick="addMember()">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É</button>
                </div>

                <h2>–°–æ—Å—Ç–∞–≤ –∫–æ–º–∞–Ω–¥—ã</h2>
                <table>
                    <thead>
                        <tr>
                            <th>–ò–º—è</th>
                            <th>ID</th>
                            <th>–†–æ–ª—å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody id="team_list">
                        </tbody>
                </table>
                <button onclick="showCreateForm()">–°–æ–∑–¥–∞—Ç—å –µ—â–µ –æ–¥–Ω—É –∫–æ–º–ø–∞–Ω–∏—é</button>
            </div>
        </div>
    </div>
    
    <div id="status_message" class="status"></div>

    <script>
        const tg = window.Telegram.WebApp;
        const mainContent = document.getElementById('main_content');
        const loading = document.getElementById('loading');
        const createForm = document.getElementById('create_form');
        const managementInterface = document.getElementById('management_interface');
        const teamManagement = document.getElementById('team_management');
        const companySelector = document.getElementById('company_selector');
        const companyListSelect = document.getElementById('company_list_select');
        const teamListBody = document.getElementById('team_list');
        const statusMessage = document.getElementById('status_message');
        const currentCompanyInfo = document.getElementById('current_company_info');

        let currentCompanyId = null;
        let isOwner = false;

        tg.ready();
        
        // --- 1. –õ–û–ì–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–• –ò –£–°–õ–û–í–ù–û–ì–û –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø ---
        function loadCompanyData() {
            loading.style.display = 'block';
            mainContent.style.display = 'none';
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–ø–∞–Ω–∏–π, –≥–¥–µ —á–∏—Å–ª–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            tg.sendData(JSON.stringify({ action: 'get_user_companies' }));
        }

        tg.onEvent('onCustomEvent', (event) => {
            if (event.event === 'onCustomData') {
                const data = JSON.parse(event.data);
                
                if (data.success) {
                    tg.showAlert(data.success);
                    if (data.reload) {
                         loadCompanyData(); 
                    } else if (data.success.includes("–¥–æ–±–∞–≤–ª–µ–Ω") || data.success.includes("–†–æ–ª—å")) {
                        tg.sendData(JSON.stringify({ action: 'get_team' })); 
                    }
                    statusMessage.textContent = ''; 
                } else if (data.error) {
                    tg.showAlert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
                    statusMessage.textContent = '';
                } else if (data.companies) {
                    handleCompaniesList(data.companies);
                } else if (data.team) {
                    displayTeam(data.team);
                    loading.style.display = 'none';
                    mainContent.style.display = 'block';
                }
            }
        });

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
        let defaultTariff = new URLSearchParams(window.location.search).get('tariff');
        
        function handleCompaniesList(companies) {
            loading.style.display = 'none';
            mainContent.style.display = 'block';
            statusMessage.textContent = '';
            
            createForm.style.display = 'none';
            managementInterface.style.display = 'block';

            if (companies.length === 0) {
                showCreateForm();
                managementInterface.style.display = 'none';
                return;
            }
            
            const currentCompany = companies.find(c => c.is_current);

            // 1. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞, –µ—Å–ª–∏ –∫–æ–º–ø–∞–Ω–∏–π > 1
            if (companies.length > 1) {
                companySelector.style.display = 'block';
                companyListSelect.innerHTML = '';
                companies.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = `${c.name} (–¢–∞—Ä–∏—Ñ: ${c.tariff.toUpperCase()})` + (c.is_current ? ' - –¢–ï–ö–£–©–ê–Ø' : '');
                    if (c.is_current) option.selected = true;
                    companyListSelect.appendChild(option);
                });
            } else {
                companySelector.style.display = 'none';
            }


            // 2. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            if (currentCompany) {
                currentCompanyId = currentCompany.id;
                isOwner = currentCompany.role === '–≤–ª–∞–¥–µ–ª–µ—Ü';
                
                currentCompanyInfo.innerHTML = `
                    <h3>–ê–∫—Ç–∏–≤–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è: ${currentCompany.name}</h3>
                    <p>–¢–∞—Ä–∏—Ñ: <strong>${currentCompany.tariff.toUpperCase()}</strong></p>
                    <p>–í–∞—à–∞ —Ä–æ–ª—å: <strong>${currentCompany.role.toUpperCase()}</strong></p>
                    <p>–ö–æ–¥ –¥–ª—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è: <code>${currentCompany.secret_code}</code></p>
                `;
                
                if (isOwner) {
                    teamManagement.style.display = 'block';
                    // –ó–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥—ã
                    tg.sendData(JSON.stringify({ action: 'get_team' }));
                } else {
                    teamManagement.style.display = 'none';
                    statusMessage.textContent = "–í—ã —è–≤–ª—è–µ—Ç–µ—Å—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º. –£–ø—Ä–∞–≤–ª—è—Ç—å –∫–æ–º–∞–Ω–¥–æ–π –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –í–ª–∞–¥–µ–ª–µ—Ü."
                }
            }
        }
        
        // --- 2. –î–ï–ô–°–¢–í–ò–Ø: –°–û–ó–î–ê–ù–ò–ï, –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï, –£–ü–†–ê–í–õ–ï–ù–ò–ï ---

        function showCreateForm() {
            createForm.style.display = 'block';
            teamManagement.style.display = 'none';
            companySelector.style.display = 'none';
            currentCompanyInfo.style.display = 'none';
            
            if (defaultTariff) {
                document.querySelector('#create_form h2').textContent = `–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é (–¢–∞—Ä–∏—Ñ: ${defaultTariff.toUpperCase()})`;
            }
        }

        function createCompany() {
            const name = document.getElementById('company_name').value.trim();
            const code = document.getElementById('company_code').value.trim();
            
            if (!name || code.length < 3) {
                tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ (>3 —Å–∏–º–≤–æ–ª–æ–≤).");
                return;
            }
            
            statusMessage.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏...";
            tg.sendData(JSON.stringify({
                action: 'create_company_from_webapp',
                name: name,
                code: code,
                tariff: defaultTariff 
            }));
        }

        function switchCompany(newCompanyId) {
            statusMessage.textContent = "–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏...";
            tg.sendData(JSON.stringify({
                action: 'switch_company',
                company_id: parseInt(newCompanyId)
            }));
        }

        function displayTeam(members) {
            teamListBody.innerHTML = '';
            
            // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ä—Ç–∏—Ä—É–µ–º: –≤–ª–∞–¥–µ–ª–µ—Ü, –ø–∞—Ä—Ç–Ω–µ—Ä, –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥
            members.sort((a, b) => {
                const order = { '–≤–ª–∞–¥–µ–ª–µ—Ü': 3, '–ø–∞—Ä—Ç–Ω–µ—Ä': 2, '–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥': 1 };
                return order[b.role] - order[a.role];
            });
            
            members.forEach(member => {
                const row = teamListBody.insertRow();
                row.insertCell().textContent = member.name || member.username || '–ù–µ—Ç –∏–º–µ–Ω–∏';
                row.insertCell().textContent = member.id;
                
                const roleCell = row.insertCell();
                const actionCell = row.insertCell();
                
                // –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ä–æ–ª–∏
                if (isOwner && member.id !== tg.initDataUnsafe.user.id) {
                    const select = document.createElement('select');
                    select.id = `role_${member.id}`;
                    
                    ['–≤–ª–∞–¥–µ–ª–µ—Ü', '–ø–∞—Ä—Ç–Ω–µ—Ä', '–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥'].forEach(role => {
                        const option = document.createElement('option');
                        option.value = role;
                        option.textContent = role.charAt(0).toUpperCase() + role.slice(1);
                        if (role === member.role) option.selected = true;
                        select.appendChild(option);
                    });
                    roleCell.appendChild(select);
                    actionCell.innerHTML = `<button onclick="changeRole(${member.id}, document.getElementById('role_${member.id}').value)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
                } else {
                    roleCell.textContent = member.role.charAt(0).toUpperCase() + member.role.slice(1);
                    actionCell.textContent = member.role === '–≤–ª–∞–¥–µ–ª–µ—Ü' ? '–ì–ª–∞–≤–Ω—ã–π' : '-'; 
                }
            });
        }

        function changeRole(targetId, newRole) {
            statusMessage.textContent = `–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ ${targetId} –Ω–∞ ${newRole}...`;
            tg.sendData(JSON.stringify({ 
                action: 'set_role', 
                target_id: targetId, 
                new_role: newRole 
            }));
        }

        function addMember() {
            const identifier = document.getElementById('new_member_id').value.trim();
            if (!identifier) {
                tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º –∏–ª–∏ ID.");
                return;
            }
            
            statusMessage.textContent = `–î–æ–±–∞–≤–ª–µ–Ω–∏–µ ${identifier}...`;
            tg.sendData(JSON.stringify({ 
                action: 'add_member', 
                identifier: identifier
            }));
            document.getElementById('new_member_id').value = '';
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        loadCompanyData();

    </script>
</body>
</html>